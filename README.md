# Домашняя работа по теме «Клиентская оптимизация»

## Проблема: страница медленно загружается
СКРИН
<p>Среднее время загрузки главной страницы в мобильном устройстве (4G сети) до события DomContentLoading - 6s, Load - 10s, на десктопе (широкополостный интернет)  - 1.5s и 5s соответственно. Это довольно много и, очевидно, что требуется оптимизация страницы.</p>

<p>Что можно сделать?</p>

### Не загружать лишнего.

- Аудит страницы в Chrome DevTools выявил 13 файлов со стилями, которые совсем не используются на странице. 
<br/>СКРИН
<br/>Удаление неиспользуемых стилей также приведет к повышению производительности страницы: браузер будет меньше тратить ресурсов на создание объектной модели таблицы стилей (CSSOM)

- 2 раза загружается библиотека JQuery. Нужно сократить до одной.

- Часть ресурсов имеет короткое время кеширования (max-age=86400) и при этом не изменялись более 6 месяцев. Для таких файлов оптимальнее выставить кеширование на более длительное время (например, на месяц). СКРИН

### Создавать меньше запросов

- Главная страница делает 21 запрос к css-файлам и 71 запрос к js-файлам (на мобильном устройстве 21 и 45 соответственно). Это нужно оптимизировать, т.к. на каждое соединение, помимо времени на непосредственное скачивание ресурса, добавляется еще и время ожидания (latency).

- Необходимо объединить js файлы. Объединять все скрипты в один будет не оптимально: получится слишком большой файл и, во-первых, увеличится время на его загрузку, а, во-вторых, есть риск, что на мобильных устройствах он не поместится в кеш браузера. <br/>
Считаю, что будет правильным объединить файлы так:
    - основные скрипты, которые нужны на всех страницах, а также очень мелкие скрипты, которые не дадут существенного увеличения размера файла, объединить в один файл;
    - остальное загружать отдельно, и только если действительно нужно на странице.

- Библиотеки jquery, nivo-lightbox, masonry и т.п. нужно загружать с CDN - сократятся сетевые задержки (latency)

- CSS нужно объединить и загрузить одним файлом.

### Передавать меньше данных

- Для большинства страниц уже используется gzip-сжатие. <br/>Нужно включить сжатие для остальных:
СКРИН

- Использовать методы zopfli + brotli для лучшего сжатия

- Минифицировать файлы js и css (не минифицировано 11 файлов с js и 9 файлов с css)

- Оптимизировать svg-графику с помощью svgo

- Разместить статику на домен без cookies

- Сжать изображения с помощью TinyPNG
СКРИН

### Оптимизировать порядок загрузки скриптов

- Установить атрибут defer для всех скриптов, чтобы избежать блокирования отображения страницы.

- CSS: Сделать минимально необходимый набор стилей, чтобы страница выглядела более-менее прилично, и выдать браузеру (можно заинлайнить, но важно, чтобы размер html файла не распух настолько, что эта оптимизация перестанет быть эффективной. В идеале, чтобы html весил не более 14kb). Остальной css объединить в один файл и выставить media="none". Браузер загрузит этот файл, но поскольку его media не соответствует текущему, он не будет его обрабатывать и соответственно не будет блокировать рендеринг. Для того, чтобы браузер применил эти свойства, в конце страницы разместить скрипт, меняющий media на all. Альтернативный вариант: расположить "неважный" css внизу страницы.

### Легкая версия для пользователей с медленным соединением.

На мобильном устройстве с медленным соединением 2G полная загрузка страницы заняла 40 секунд.<br/>
Помимо указанных выше мер по оптимизации сайта, нужно сделать легкую версию:<br/>
- уменьшить размер html (например, сократив количество новостей на главной странице)
- уменьшить количество загружаемых шрифтов

## Проблема: необходима оптимизация производительности страницы

- В секции head указан dns-prefetch для домена, на который нет ссылок. Это нужно убрать: 
```html
<link rel="dns-prefetch" href="//s.w.org" />
```

- Заменить сложные селекторы CSS на классы. Сократится время на обработку стилей и построения CSSOM

- Оптимизировать скрипты, которые выполняются долго или вызывают пересчет стилей. <br/><br/>
Например, есть функция isElementInViewport*, которая определяет находится ли элемент в видимой части окна. Для этого она вычисляет координаты элемента с помощью getBoundingClientRect, который в свою очередь заставляет браузер запускать reflow (процесс обхода DOM, вычисляющий геометрию элементов и их положение относительно родителя). Функция isElementInViewport выполняется для каждого элемента с классом .lazy-load (их > 70) и при каждом событии scroll. Приводит это к тому, что производительность страницы при скролле на мобильном устройстве падает до 10-15 fps.<br/><br/>
Что можно с этим сделать?
    - применить паттерн debounce для уменьшения частоты вызова обработчика события scroll
    - сократить обращение к DOM, закешировав найденные элементы .lazy-load перед обработчиком события scroll
 <br/><br/>*код расположен в файле https://lifehacker.ru/wp-content/themes/lifehacker/static/js/all.min.js?ver=219, строки 224-284
